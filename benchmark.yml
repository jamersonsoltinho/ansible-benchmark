- name: Telegram benchmark for 15 minutes
  hosts: localhost
  vars:
    telegram_token: "7709438233:AAHhbzrkAUjxEJwCptMvuL3RyZSdZ8Vqw2Q"
    chat_id: "2018308195"
    duration_minutes: 15
    interval_seconds: 60  # tempo entre cada execuÃ§Ã£o (em segundos)
    iterations: "{{ (duration_minutes * 60 / interval_seconds) | int }}"
  tasks:

    - name: Notify start
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ chat_id }}"
          text: "ğŸš€ Benchmark iniciado! Vai rodar por {{ duration_minutes }} minutos com {{ iterations }} iteraÃ§Ãµes."

    - name: Run benchmark loop
      loop: "{{ range(0, iterations)|list }}"
      loop_control:
        index_var: i
      block:
        - name: Run test command
          command: ping -c 1 google.com
          register: test_result
          ignore_errors: yes

        - name: Save result to file
          lineinfile:
            path: /tmp/telegram_benchmark.log
            line: "{{ lookup('pipe', 'date +%T') }} - IteraÃ§Ã£o {{ i + 1 }} - {{ 'OK' if test_result.rc == 0 else 'FAIL' }}"

        - name: Wait between iterations
          pause:
            seconds: "{{ interval_seconds }}"

    - name: Calculate successful tests
      command: bash -c "grep -c OK /tmp/telegram_benchmark.log || true"
      register: ok_count

    - name: Calculate total tests
      command: bash -c "wc -l /tmp/telegram_benchmark.log | awk '{print $1}'"
      register: total_count

    - name: Notify completion
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ chat_id }}"
          text: |
            âœ… Benchmark finalizado!
            ğŸ•’ DuraÃ§Ã£o: {{ duration_minutes }} minutos
            ğŸ” Total de execuÃ§Ãµes: {{ total_count.stdout }}
            ğŸŸ¢ Sucessos: {{ ok_count.stdout }}
            ğŸ”´ Falhas: {{ total_count.stdout | int - ok_count.stdout | int }}
