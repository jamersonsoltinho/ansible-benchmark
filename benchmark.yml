---
- name: Telegram benchmark for 15 minutes
  hosts: localhost
  vars:
    telegram_token: "7709438233:AAHhbzrkAUjxEJwCptMvuL3RyZSdZ8Vqw2Q"
    chat_id: "2018308195"
    duration_minutes: 15
    interval_seconds: 60     # executa a cada 60 segundos
    start_time: "{{ lookup('pipe', 'date +%s') }}"
  tasks:

    - name: Notify start
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ chat_id }}"
          text: "ðŸš€ Benchmark iniciado! Vai rodar por {{ duration_minutes }} minutos."

    - name: Run benchmark loop
      vars:
        end_time: "{{ lookup('pipe', 'date +%s') | int + (duration_minutes * 60) }}"
      block:
        - name: Execute until 15 minutes pass
          while: "{{ lookup('pipe', 'date +%s') | int < end_time }}"
          block:
            - name: Run test command
              command: ping -c 1 google.com
              register: test_result
              ignore_errors: yes

            - name: Save result to file
              lineinfile:
                path: /tmp/telegram_benchmark.log
                line: "{{ lookup('pipe', 'date +%T') }} - {{ 'OK' if test_result.rc == 0 else 'FAIL' }}"

            - name: Wait interval
              pause:
                seconds: "{{ interval_seconds }}"
          loop_control:
            label: "Benchmark iteration"

    - name: Calculate results
      command: bash -c "grep -c OK /tmp/telegram_benchmark.log || true"
      register: ok_count

    - name: Calculate total runs
      command: bash -c "wc -l /tmp/telegram_benchmark.log | awk '{print $1}'"
      register: total_count

    - name: Notify completion
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ chat_id }}"
          text: |
            âœ… Benchmark finalizado!
            ðŸ•’ DuraÃ§Ã£o: {{ duration_minutes }} minutos
            ðŸ” Total de execuÃ§Ãµes: {{ total_count.stdout }}
            ðŸŸ¢ Sucessos: {{ ok_count.stdout }}
            ðŸ”´ Falhas: {{ total_count.stdout | int - ok_count.stdout | int }}
