---
- name: Telegram benchmark for 25 minutes
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    telegram_token: "7709438233:AAHhbzrkAUjxEJwCptMvuL3RyZSdZ8Vqw2Q"
    chat_id: "2018308195"
    duration_minutes: 25   # <-- alterado de 15 para 25
    interval_seconds: 60
    iterations: "{{ (duration_minutes * 60 / interval_seconds) | int }}"

  tasks:
    - name: Notify start
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ chat_id }}"
          text: "ðŸš€ Benchmark iniciado! Vai rodar por {{ duration_minutes }} minutos com {{ iterations }} iteraÃ§Ãµes."

    - name: Run benchmark iteration
      include_tasks: "{{ playbook_dir }}/iterator.yml"
      loop: "{{ range(1, (iterations | int) + 1) | list }}"
      loop_control:
        loop_var: idx

    - name: Count successful tests
      command: bash -c "grep -c OK /tmp/telegram_benchmark.log || true"
      register: ok_count

    - name: Count total tests
      command: bash -c "wc -l /tmp/telegram_benchmark.log | awk '{print $1}'"
      register: total_count

    - name: Notify completion
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ chat_id }}"
          text: |
            âœ… Benchmark finalizado!
            ðŸ•’ DuraÃ§Ã£o: {{ duration_minutes }} minutos
            ðŸ” Total de execuÃ§Ãµes: {{ total_count.stdout }}
            ðŸŸ¢ Sucessos: {{ ok_count.stdout }}
            ðŸ”´ Falhas: {{ total_count.stdout | int - ok_count.stdout | int }}

    - name: Notify forced error on Telegram
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ chat_id }}"
          text: "âš ï¸ Um erro forÃ§ado serÃ¡ gerado agora para testar o comportamento pÃ³s-benchmark."

    - name: Force an error after benchmark
      fail:
        msg: "ðŸ’¥ Erro forÃ§ado apÃ³s os {{ duration_minutes }} minutos de benchmark!"
